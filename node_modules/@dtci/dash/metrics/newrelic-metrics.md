# New Relic (Application Metrics)

Newrelic provides tools and scripts that allow you to aggregate performance and monitoring data for Infastructure, Applications, and Client side interactions

[[_TOC_]]

## Overview

The monitoring side of new relic is split between the following areas:

* **NewRelic APM** - Lives as a running process on your express server to monitor the health of the application, transactions and the Kubernetes pod.
* **NewRelic Browser** - Embeds a script tag on your website that allows for collecting client side rendering trees, JS errors, and AJAX performance.
* **NewRelic Infastructure** - Tracks details of your environment performance (IE. Docker, Kubernetes)

## Permissions

### DATG - IT

This is a shared account that our applications utilize for reporting.

You can setup newrelic APM without being able to access New Relic monitoring. If you need access to the GUI for new relic you will need to request it.

1. Visit https://issues.dtci.technology/
2. Choose Enterprise Products as the application type
3. Select DATG New Relic as the product
4. Put in an access request including your managers name/email for approval
5. UI Engineers should request full add-on permissions: 
6. Inlude the permissions level you need. Start with: Alerts manager, APM manager, Browser manager, Infrastructure manager, Insights manager, Synthetics manager, Incident intelligence manager

New Relic can then be accessed via MyID from: https://rpm.newrelic.com/

## App Configuration

### Minimum Configuration

For a basic integration you only require an application name and a license key. 

### Application Naming

Currently, the required naming scheme for UIET specs is:

> **[application-name]\_ui\_[environment]\_[region]\_[tribe]\_[deployment-method]**

* [application-name] - Dash seperated name of your application
* [environment] - Type of environment (dev,stage,etc)
* [region] - If applicable, the region if you're tracking regions as separate apps. 
* [tribe] - The tribe the project lives under
* [deployment-method] - How the application is deployed (likely the k8s pipeline for UIET projects)

> ex. **release-notes_ui_dev_ep-swe-softsol_k8s**

Using this scheme lets us search the New Relic GUI by a variety of criteria that may be useful in the future.

### Indirect vs Direct Setup

Newrelic can be setup directly with a config file or indirectly with environment variables in HELM. For the basic integration, we recommend indirect configuration.

### Indirect Environment Variables

* **NEW_RELIC_NO_CONFIG_FILE** - Boolean set to true
* **NEW_RELIC_APP_NAME** - Name of your application
* **NEW_RELIC_LICENSE_KEY** - DATG New Relic license key (or another key if your application or tribe is using a different account)
* **NEW_RELIC_DISTRIBUTED_TRACING_ENABLED** - Boolean set to true
* **NEW_RELIC_LABELS** - Semicolon seperated key/value pairs

A full list of available environment variables is available from the [newrelic package](https://github.com/newrelic/node-newrelic/blob/master/lib/config/default.js). They are marked with @env.

### Labels

Labels can be used in NewRelic to define logical groups of applications. In the UI they can be used for filtering, reporting, and alerting profiles which makes them a useful tool. The following labels should be added to your application.

- Application-Type - The type of application
  - Internal-Tool - Within the DGN only
  - Internet-Facing - Available off the DGN but behind MyID
  - Consumer-Facing - Off the DGN with public access
- Environment - What kind of environment is being run
  - Development, Stage, Qe, Production, Pre-Prod, Performance
- Region - If applicable, the region you're running under
  - East, West
- Tribe - Which tribe does this application serve
  - ep-swe-affiliate, ep-swe-fin-acct, ep-swe-operations, ep-swe-programming, ep-swe-softsol, ep-swe-traffic
  - Internal UI tools typically serve ep-swe-softsol
- Technology-Stack - What type of application is this
  - Endgame - Modern react stack
- Application-Name - The name of your application, ie. release-notes-ui or tribes-ui
- Production - Yes/No
- UI - Yes/No
- Monitored - Yes/No

You can add these to your project via HELM environment variables. It accepts a semicolon separated list of Label:Value pairs. 

```
  - name: NEW_RELIC_LABELS
    value: "Environment:Development;Application-Type:Internal-Tool;Tribe:ep-swe-softsol;Technology-Stack:Endgame;Application-Name:release-notes-ui;Production:Yes;UI:Yes"
```

## Client Alert Profiles

### APM Metrics

You can use application Tags when setting these up. Typically configured with "UI: Yes" and "Production" either Yes/No depending on profile.

### Browser Metrics

Must tag specific applications

### Production

**APM - Error percentage (High)**

Description: Checks for high error rates in server responses  
Thresholds: Warning Threshold of 5%, Error threshold of 10%  
Rate: Once in 5 minutes  
Alerts: Private Slack Group, #ep-swe-ui-alarms

**APM - Apdex (Low)**

Description: Checks for user satisfication score based on key metrics  
Thresholds: Warning Threshold of .85, Error threshold of .7  
Rate: Sustained for 5 minutes  
Alerts: Private Slack Group, #ep-swe-ui-alarms

### Non-Production

**APM - Error percentage (High)**

Description: Checks for high error rates in server responses  
Thresholds: Warning Threshold of 5%, Error threshold of 10%  
Rate: Once in 5 minutes  
Alerts: Private Slack Group, #ep-swe-ui-health

**APM - Apdex (Low)**

Description: Checks for user satisfication score based on key metrics  
Thresholds: Warning Threshold of .85, Error threshold of .7  
Rate: Sustained for 5 minutes  
Alerts: Private Slack Group, #ep-swe-ui-health

## Infastructure Alert Profiles

Infastructure alerting does not have access to your application tags. For this reason, it is currently necessary to group your applications for alerting based off kubernetes tag details or individual application names. We currently provide the following alert profiles.

### Production

**UIET - Container % CPU**

Description: Checks to make sure running containers have sufficient CPU to run the application  
Thresholds: Warning Threshold of 70%, Error threshold of 85%  
Rate: Sustained for at least 3 minutes  
Alerts: Private Slack Group, #ep-swe-ui-alarms

**UIET - Container % Memory**

Description: Checks to make sure running containers have sufficient memory to run the application  
Thresholds: Warning Threshold of 70%, Error threshold of 90%  
Rate: Sustained for at least 3 minutes  
Alerts: Private Slack Group, #ep-swe-ui-alarms

**UIET - Missing Pods**

Description: Checks to make sure running pods does not drop below requested pods  
Alerts: Private Slack Group, #ep-swe-ui-alarms

**UIET - Pod Refreshes**
Description: Checks to see if Kubernetes is killing/restarting pods too frequently  
Thresholds: Warning Threshold of 3 refresges, Error threshold of 5 refreshes  
Rate: Once in 10 minutes  
Alerts: Private Slack Group, #ep-swe-ui-alarms

#### Tags

**CLUSTER NAME**  
upic-adsales-prd-eks

**DEPLOYMENT NAME**  
All UI Applications currently in production

### Non-Production

**UIET- Non-Prod Container % CPU**

Description: Checks to make sure running containers have sufficient CPU to run the application  
Thresholds: Warning Threshold of 70%, Error threshold of 85%  
Rate: Sustained for at least 3 minutes  
Alerts: Private Slack Group, #ep-swe-ui-health

**UIET - Non-Prod Container % Memory**

Description: Checks to make sure running containers have sufficient memory to run the application  
Thresholds: Warning Threshold of 70%, Error threshold of 90%  
Rate: Sustained for at least 3 minutes  
Alerts: Private Slack Group, #ep-swe-ui-health

**UIET - Non-Prod Missing Pods**

Description: Checks to make sure running pods does not drop below requested pods  
Alerts: Private Slack Group, #ep-swe-ui-health

**UIET - Non-Prod Pod Refreshes**
Description: Checks to see if Kubernetes is killing/restarting pods too frequently  
Thresholds: Warning Threshold of 3 refresges, Error threshold of 5 refreshes  
Rate: Once in 10 minutes  
Alerts: Private Slack Group, #ep-swe-ui-health

#### Tags

**CLUSTER NAME**  
upic-adsales-eks

**DEPLOYMENT NAME**  
All UI Applications currently in production

## Anomoly Detection

Most alerting is for active detection where you specifically assign an issue and threshold for problematic behavior of your application. An additional feature to utilize is proactive detection offered via NewRelic Applied Intelligence. Over time AI determines what your applications typical performance looks like and triggers an alert when it deviates from the baseline metrics by some degree. This lets you capture possible error states developers haven't thought of by understanding how metrics are deviating from the typical user performance.

We leverage the following profiles.

**Enterprise Engineering - Prod Realtime Alerts**

Description: Monitors our production applications
Alerts: Private Slack Group, #ep-swe-ui-alarms

## Setup

### Initial Setup

1. **(Application)** Install [newrelic](https://www.npmjs.com/package/newrelic) and [@types/newrelic](https://www.npmjs.com/package/@types/newrelic) packages
2. **(NewRelic APM)** Include newrelic as part of you express server startup (this can be accomplished easily with a newrelicMiddleware).
3. **(NewRelic Browser)** Include the browser timing header from newrelic in your server side HTML template.

### Post Setup

1. **(NewRelic Browser)** - AJAX: To enable advanced browser features such as AJAX monitoring, it must be manually enabled for each environment using new relic after the initial deployment by someone with access to the GUI. It is a one-click setup.
2. **(NewRelic Browser)** - SPA: To enable your application as a SPA (Single Page ), it must be manually setup for each environment using new relic after the initial deployment by someone with access to the GUI. You can set the application as "Pro + SPA" under application settings.
3. **(NewRelic Infastructure)** - Add your application to the infastructure alert profiles
4. **(NewRelic AI)** - Add your application to the anomoly detection

## References

- [New Relic](https://rpm.newrelic.com/)
- [New Relic Docs](https://docs.newrelic.com/)