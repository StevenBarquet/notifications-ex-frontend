# Request Tracing

This guide outlines some tools available for tracing requests through various pieces of the stack - depending on what you have available to you.

[[_TOC_]]

## NewRelic

The majority of NewRelic data is provided in an aggregate fashion providing average metrics across a number of requests within a time period. However, you can use some of the tooling to deep dive into individual requests.

### Insights

NewRelic Insights provides a SQL-like query language for looking into the various data tables produced by NewRelic requests

**Sample Query:**

```
SELECT * FROM Transaction WHERE appName ='workforce_ui_dev_ep-swe-softsol_k8s' SINCE 1 day ago UNTIL 1 hour ago LIMIT 2000
```

This would look up all data from the Transaction table where:

- The application entity name is "workforce_ui_dev_ep-swe-softsol_k8s"
- The time period of the transaction was between yesterday and today (1 prior previous to the query)
- Limited to the most recent 2000 requests (NewRelic Maximum)

### Insights Table Data

- Transaction - Transaction event includes information about the app, the duration of the transaction, and response details.
- PageView - Tracks geographic and timing data for each browser page load.
- PageAction - Its attributes provide app and geographic data, as well as data about the userâ€™s browser dimensions, session IDs, and referring and page URLs
- BrowserInteraction / AjaxRequest - Event information in SPA's

### Distributed Tracing

If you have enabled Distributed Tracing in NewRelic tooling, you can use it to help cross the bridge between the different pieces. For example, if tracing is enabled on both APM & Browser. An important note is that NewRelic samples differently between Browser & APM - you may see disconnected traces where one was sampled but not the other.

[Distributed Tracing](https://one.newrelic.com/launcher/distributed-tracing-nerdlets.distributed-tracing)

### Request ID

In applications consuming an appropriate version of our logging framework we add a unique request ID to our traffic logging in applications. This can be mapped in either direction to NewRelic using the "Transaction" table discussed above, ie.

```
SELECT * FROM Transaction WHERE appName ='workforce_ui_dev_ep-swe-softsol_k8s' AND requestId='6c015a24-f7ef-47a3-97e7-0ae6a667d984'
```

### References

- [NRQL](https://docs.newrelic.com/docs/query-your-data/nrql-new-relic-query-language/get-started/nrql-syntax-clauses-functions)

## CloudWatch

### Application Logs

These correspond to logs pulled from the docker pods.

- Region - us-west-2
- Log Group (Non-Prod) - adsales-nonprod-eks
- Log Group (Prod) - adsales-prod-eks

**Basic Query:**

```
fields @timestamp, @message
| filter kubernetes.namespace_name like /ep-swe-softsol-dev/
| filter kubernetes.pod_name like /endgame/
| filter @message like /My App Error/
| sort @timestamp desc
| limit 20

```

**This query would query:**

- Pods in the "ep-swe-softsol-dev" namespace (namespace is set in your helm files)
- Pods that contain the string "endgame" (pod names include a unique hash when they come up, use LIKE queries to fetch ALL pods related to your application)
- Includes a substring of "My App Error" (the more specific the less false positives)
- Last 20 results (based on your sort direction)


### Kubernetes Logs

These correspond to logs internal to the kubernetes cluster

- Region - us-west-2
- Log Group (Non-Prod) - /aws/eks/upic-adsales-eks/cluster
- Log Group (Prod) - /aws/eks/upic-adsales-prd-eks/cluster

### References

- [Cloudwatch](https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#)
- [CloudWatch Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
- [Grafana](https://grafana.dtci.technology/)

## Application

### Morgan

Morgan handles traffic monitoring for a pod and logs details of the requests coming through the express server. It is an express middleware package. It includes the following:

- Timestamp
- Request ID (unique session ID for the request)
- Trace ID (AWS Trace-ID)
- Request IP - The IP address making the request (often internal for proxied applications)
- Client IP - Our best determination of the actual IP address of the user
- Method - HTTP Method
- URL - Path accessed
- Status - HTTP Status Code
- Response - Response Time

#### Trace ID

As part of our traffic monitoring package, we also include the AWS Trace-ID that is passed through in the HTTP Headers of the application. This should allow you to trace logs up to the ALB level.

```
time=21/Aug/2020:14:29:09 +0000 requestId=8b7d24a7-6a32-45ca-a03e-ca8876469d17 traceId=Root=1-5f3fda35-a88f76457da064430e774069 requestIp=::ffff:10.39.201.188 clientIp=192.234.2.90 method=GET url=/org status=200 response=1.296 ms
```

```traceId=Root=1-5f3fda35-a88f76457da064430e774069```

#### Client IP

As part of our traffic monitoring package, we also include our best determination of the users real IP address. This is determined from HTTP headers in a proxied environment, such as X-Forwarded-For. A

```
time=21/Aug/2020:14:29:09 +0000 requestId=8b7d24a7-6a32-45ca-a03e-ca8876469d17 traceId=Root=1-5f3fda35-a88f76457da064430e774069 requestIp=::ffff:10.39.201.188 clientIp=192.234.2.90 method=GET url=/org status=200 response=1.296 ms
```

```clientIp=192.234.2.90```



